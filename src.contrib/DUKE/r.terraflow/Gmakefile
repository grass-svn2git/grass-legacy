SOURCES = main.cc common.cc stats.cc fill.cc types.cc ccforest.cc \
	nodata.cc plateau.cc direction.cc water.cc  \
	filldepr.cc grid.cc genericWindow.cc \
	flow.cc sweep.cc weightWindow.cc

HEADERS = common.h stats.h streamutils.h types.h \
	option.h fill.h main.h \
	nodata.h ccforest.h	sortutils.h 3scan.h\
	plateau.h direction.h genericWindow.h \
	water.h grass2str.h filldepr.h unionFind.h \
	grid.h genericWindow.h flow.h sweep.h \
	weightWindow.h


FLOAT_OBJ = $(patsubst %.cc, FLOAT/%.o , $(SOURCES))
SHORT_OBJ = $(patsubst %.cc, SHORT/%.o , $(SOURCES))


IOSTREAM_DIR = IOStream
IOSTREAM_INC = $(IOSTREAM_DIR)/include
IOSTREAM_LIBDIR = $(IOSTREAM_DIR)/lib
IOSTREAM_LIB = $(IOSTREAM_LIBDIR)/libiostream.a


WARNING_FLAGS   = -Wformat  -Wparentheses  -Wpointer-arith -Wno-conversion \
  -Wimplicit-int -Wimplicit-function-declaration -Wreturn-type	\
  -Wcomment  -Wno-sign-compare


EXTRA_CXXFLAGS = -I$(IOSTREAM_INC) -DNODATA_FIX -D_FILE_OFFSET_BITS=64

LIBS = $(IOSTREAM_LIB) $(GISLIB) $(MATHLIB) $(XDRLIB)
DEPLIBS = $(IOSTREAM_LIB) $(DEPGISLIB)


all: $(IOSTREAM_LIB) $(BIN_CMD)/r.terraflow $(BIN_CMD)/r.terraflow.short

$(BIN_CMD)/r.terraflow: $(OBJARCH)/FLOAT $(FLOAT_OBJ) $(DEPLIBS)
	$(CXX) -DELEV_FLOAT $(LDFLAGS) -o $@ $(FLOAT_OBJ) $(LIBS)

$(BIN_CMD)/r.terraflow.short: $(OBJARCH)/SHORT $(SHORT_OBJ) $(DEPLIBS)
	$(CXX) -DELEV_SHORT $(LDFLAGS) -o $@ $(SHORT_OBJ) $(LIBS)

$(IOSTREAM_LIB):
	$(GMAKE) IOStream/lib

$(OBJARCH)/FLOAT:
	-mkdir -p $(OBJARCH)/FLOAT

$(OBJARCH)/SHORT:
	-mkdir -p $(OBJARCH)/SHORT

#Note: 	if a header file is modified, the .o files do not get rebuilt..
#		header files should be included as prerequisites, but does not work 
#		because of GRASS scripts 
FLOAT/%.o : %.cc
	$(CXX) -c $(CXXFLAGS) -DELEV_FLOAT $< -o $@

SHORT/%.o : %.cc
	$(CXX) -c $(CXXFLAGS) -DELEV_SHORT $< -o $@

$(DEPGISLIB):	#


clean: 
	-rm $(OBJARCH)/FLOAT/*
	-rm $(OBJARCH)/SHORT/*
