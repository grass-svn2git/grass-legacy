#! /bin/sh
#############################################################################
#
# $Id$
#
# MODULE:   	GRASS Initialization
# AUTHOR(S):	Justin Hickey - Thailand - jhickey@hpcc.nectec.or.th
# PURPOSE:  	The source file for this shell script is in
#   	    	lib/init/grass.src and is the grass startup script. It
#   	    	requires a source file because the definition of GISBASE
#   	    	is not known until compile time and is substituted from the
#   	    	Makefile. Any command line options are passed to Init.sh.
# COPYRIGHT:    (C) 2000-2005 by the GRASS Development Team
#
#               This program is free software under the GNU General Public
#   	    	License (>=v2). Read the file COPYING that comes with GRASS
#   	    	for details.
#
#############################################################################

# Mac app only startup shell - complete rewrite for starting from a GRASS.app
# in Mac OS X.  Sets defaults for unset env, adds some Mac-only config.
#   William Kyngesburye
#   kyngchaos@kyngchaos.com

trap "echo 'User break!' ; exit" 2 3 9 15

# dummy for now - just saying we're starting GRASS.app on OSX
GRASS_OS_STARTUP="Mac.app"
export GRASS_OS_STARTUP

GISBASE="`dirname $0`"
export GISBASE
grass_ver=`cut -d . -f 1-2 $GISBASE/etc/VERSIONNUMBER`

# for GDAL utils
# hack - ideally user should have this in their PATH
PATH="@GDAL_BIN_PATH@:$PATH"
export PATH

# xterm
if [ ! "$GRASS_XTERM" ] ; then
	GRASS_XTERM=/usr/X11R6/bin/xterm
	export GRASS_XTERM
fi

# default to internal X11 Tcl/Tk
@TCLTK_INTERNAL@if [ ! "$GRASS_TCLSH" ] ; then
	GRASS_TCLSH="$GISBASE/bin/tclsh8.4"
	export GRASS_TCLSH
	GRASS_WISH="$GISBASE/bin/wish8.4"
	export GRASS_WISH
	# internal - force osxaqua off
	unset osxaqua
	# override TCL_LIBRARY to internal
	TCL_LIBRARY="$GISBASE/lib/tcl8.4"
	export TCL_LIBRARY
	TK_LIBRARY="$GISBASE/lib/tk8.4"
	export TK_LIBRARY
@TCLTK_INTERNAL@fi

# make sure there is a DISPLAY set
if [ ! "$DISPLAY" ] ; then
	DISPLAY=:0.0
	export DISPLAY
fi

# add some OS X style App Support paths, and create user one if missing.
mkdir -p "$HOME/Library/GRASS/$grass_ver/Modules/bin"
if [ "$GRASS_ADDON_PATH" ] ; then
	GRASS_ADDON_PATH="$GRASS_ADDON_PATH:$HOME/Library/GRASS/$grass_ver/Modules/bin:/Library/GRASS/$grass_ver/Modules/bin"
else
	GRASS_ADDON_PATH="$HOME/Library/GRASS/$grass_ver/Modules/bin:/Library/GRASS/$grass_ver/Modules/bin"
	
fi
export GRASS_ADDON_PATH

mkdir -p "$HOME/Library/GRASS/$grass_ver/Modules/lib"
DYLD_LIBRARY_PATH="$HOME/Library/GRASS/$grass_ver/Modules/lib:/Library/GRASS/Modules/lib"
export DYLD_LIBRARY_PATH
mkdir -p "$HOME/Library/GRASS/$grass_ver/Modules/etc"
mkdir -p "$HOME/Library/GRASS/$grass_ver/Modules/docs/html"

# rebuild addon html index and gui menus
"$GISBASE/etc/build_html_user_index.sh" "$GISBASE"
"$GISBASE/etc/build_gui_user_menu.sh"

# start X11 if not running - no need to check if running by using 'open'
# some users may be annoyed by this, but X11 required for some stuff for now
if [ -d "/Applications/Utilities/X11.app" ] ; then
	open /Applications/Utilities/X11.app
fi

# if gisrc has text startup, switch back to Terminal (gotta duplicate some init.sh stuff)
# eventually, when TclTk optional, can run appropriate apps per GUI here (ie X11)
GISRCRC="$HOME/.grassrc6"
if [ -f "$GISRCRC" ] ; then
	GRASS_GUI=`awk '/GRASS_GUI/ {print $2}' "$GISRCRC"`
fi
if [ ! "$GRASS_GUI" ] ; then
	GRASS_GUI="tcltk"
fi
if [ "$GRASS_GUI" = "text" ] ; then
	osascript -e 'tell application "Terminal" to activate'
fi

exec "$GISBASE/etc/Init.sh" "$@"
